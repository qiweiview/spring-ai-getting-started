<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI 实战范例</title>
    <style>
        /* ==================== Reset & Base ==================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1C64F2;
            --primary-light: #E1EFFE;
            --primary-hover: #1A56DB;
            --bg: #F9FAFB;
            --bg-white: #FFFFFF;
            --text-primary: #111928;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --border: #E5E7EB;
            --border-light: #F3F4F6;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.03);
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                         'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        /* ==================== Header ==================== */
        .header {
            height: 56px;
            background: var(--bg-white);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
            z-index: 10;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            width: 32px; height: 32px;
            background: var(--primary);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: white;
        }

        .header-logo svg {
            width: 18px; height: 18px;
        }

        .header h1 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .header h1 small {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-tertiary);
            margin-left: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-icon {
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .btn-icon:hover {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .btn-icon svg {
            width: 16px; height: 16px;
        }

        .btn-clear {
            padding: 6px 14px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-clear:hover {
            background: var(--border-light);
            color: var(--text-primary);
            border-color: #D1D5DB;
        }

        .btn-clear svg {
            width: 14px; height: 14px;
        }

        /* ==================== Main Content ==================== */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }

        /* ==================== Left: Chat Panel ==================== */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            min-width: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .chat-messages-inner {
            max-width: 768px;
            margin: 0 auto;
            padding: 24px 24px 16px;
        }

        /* ==================== Welcome ==================== */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px 40px;
        }

        .welcome-avatar {
            width: 56px; height: 56px;
            background: var(--primary);
            border-radius: 16px;
            display: flex;
            align-items: center; justify-content: center;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(28, 100, 242, 0.2);
        }

        .welcome-avatar svg {
            width: 28px; height: 28px;
            color: white;
        }

        .welcome h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .welcome p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .tips {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-width: 480px;
            width: 100%;
        }

        .tip {
            padding: 14px 16px;
            background: var(--bg-white);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.15s ease;
            user-select: none;
            text-align: left;
            line-height: 1.5;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tip:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            box-shadow: var(--shadow-sm);
        }

        /* ==================== Chat Messages ==================== */
        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: var(--primary);
            color: white;
        }

        .user .message-avatar svg {
            width: 16px; height: 16px;
        }

        .ai .message-avatar {
            background: var(--primary-light);
            color: var(--primary);
        }

        .ai .message-avatar svg {
            width: 16px; height: 16px;
        }

        .message-content {
            max-width: 72%;
            min-width: 60px;
        }

        .message-name {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            padding: 0 2px;
            font-weight: 500;
        }

        .user .message-name { text-align: right; }

        .message-bubble {
            padding: 10px 14px;
            border-radius: var(--radius-lg);
            line-height: 1.7;
            font-size: 14px;
            word-break: break-word;
        }

        .user .message-bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai .message-bubble {
            background: var(--bg-white);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border);
        }

        /* AI message markdown rendering */
        .ai .message-bubble p { margin: 6px 0; }
        .ai .message-bubble p:first-child { margin-top: 0; }
        .ai .message-bubble p:last-child { margin-bottom: 0; }

        .ai .message-bubble pre {
            background: #F9FAFB;
            padding: 12px 14px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid var(--border);
        }

        .ai .message-bubble code {
            font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            font-size: 13px;
        }

        .ai .message-bubble :not(pre) > code {
            background: var(--primary-light);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
            color: var(--primary);
        }

        .ai .message-bubble strong { color: var(--text-primary); font-weight: 600; }

        .ai .message-bubble ul, .ai .message-bubble ol {
            padding-left: 20px;
            margin: 8px 0;
        }

        .ai .message-bubble li { margin: 4px 0; }

        .ai .message-bubble a {
            color: var(--primary);
            text-decoration: none;
        }

        .ai .message-bubble a:hover {
            text-decoration: underline;
        }

        /* Typing indicator */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 4px 0;
            align-items: center;
        }

        .typing-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--text-tertiary);
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        /* ==================== Right: Process Panel ==================== */
        .process-panel {
            width: 400px;
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-left: 1px solid var(--border);
        }

        .process-header {
            height: 48px;
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .process-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .process-header-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: background 0.3s;
        }

        .process-header-dot.active {
            background: #10B981;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
        }

        .process-events {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }

        .process-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
            font-size: 13px;
            line-height: 2;
        }

        .process-empty-icon {
            width: 48px; height: 48px;
            background: var(--border-light);
            border-radius: 12px;
            display: inline-flex;
            align-items: center; justify-content: center;
            margin-bottom: 16px;
        }

        .process-empty-icon svg {
            width: 22px; height: 22px;
            color: var(--text-tertiary);
        }

        /* Process Event Item */
        .process-event {
            position: relative;
            padding-left: 28px;
            padding-bottom: 16px;
            animation: fadeIn 0.25s ease;
        }

        /* Timeline line */
        .process-event::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 22px;
            bottom: 0;
            width: 1px;
            background: var(--border);
        }

        .process-event:last-child::before { display: none; }

        /* Timeline dot */
        .process-event-dot {
            position: absolute;
            left: 1px;
            top: 5px;
            width: 14px; height: 14px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 8px;
            border: 2px solid var(--bg-white);
            box-shadow: 0 0 0 1px var(--border);
        }

        .process-event.model_init   .process-event-dot { background: #3B82F6; box-shadow: 0 0 0 1px #3B82F6; }
        .process-event.prompt_build  .process-event-dot { background: #8B5CF6; box-shadow: 0 0 0 1px #8B5CF6; }
        .process-event.tool_register .process-event-dot { background: #F59E0B; box-shadow: 0 0 0 1px #F59E0B; }
        .process-event.api_call      .process-event-dot { background: #F97316; box-shadow: 0 0 0 1px #F97316; }
        .process-event.streaming     .process-event-dot { background: #10B981; box-shadow: 0 0 0 1px #10B981; }
        .process-event.tool_call     .process-event-dot { background: #EAB308; box-shadow: 0 0 0 1px #EAB308; }
        .process-event.tool_result   .process-event-dot { background: #8B5CF6; box-shadow: 0 0 0 1px #8B5CF6; }
        .process-event.complete      .process-event-dot { background: #10B981; box-shadow: 0 0 0 1px #10B981; }
        .process-event.error         .process-event-dot { background: #EF4444; box-shadow: 0 0 0 1px #EF4444; }

        .process-event-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }


        .process-event-time {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 400;
            margin-left: auto;
        }

        .process-event-content {
            font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            font-size: 12px;
            line-height: 1.7;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
            background: var(--bg);
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            max-height: 160px;
            overflow-y: auto;
        }

        /* Step-specific content colors */
        .process-event.streaming .process-event-content {
            max-height: 240px;
            color: #059669;
            border-color: #D1FAE5;
            background: #ECFDF5;
        }

        .process-event.tool_call .process-event-content {
            color: #B45309;
            border-color: #FDE68A;
            background: #FFFBEB;
        }

        .process-event.tool_result .process-event-content {
            color: #6D28D9;
            border-color: #DDD6FE;
            background: #F5F3FF;
        }

        .process-event.complete .process-event-content {
            color: #059669;
            border-color: #D1FAE5;
            background: #ECFDF5;
        }

        .process-event.error .process-event-content {
            color: #DC2626;
            border-color: #FECACA;
            background: #FEF2F2;
        }

        /* ==================== Input Area ==================== */
        .input-area {
            padding: 16px 24px 20px;
            background: var(--bg);
            flex-shrink: 0;
        }

        .input-container {
            max-width: 768px;
            margin: 0 auto;
            position: relative;
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(28, 100, 242, 0.1), var(--shadow-md);
        }

        .message-input {
            width: 100%;
            padding: 14px 60px 14px 18px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            outline: none;
            font-family: inherit;
            background: transparent;
            resize: none;
            line-height: 1.5;
            min-height: 48px;
            max-height: 160px;
            color: var(--text-primary);
        }

        .message-input::placeholder { color: var(--text-tertiary); }

        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-send {
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-send svg {
            width: 18px; height: 18px;
        }

        .btn-send:hover:not(:disabled) {
            background: var(--primary-hover);
            box-shadow: var(--shadow-sm);
        }

        .btn-send:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .btn-stop {
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-stop svg {
            width: 16px; height: 16px;
        }

        .btn-stop:hover {
            background: #DC2626;
            box-shadow: var(--shadow-sm);
        }

        .input-hint {
            text-align: center;
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 8px;
        }

        /* ==================== Scrollbar ==================== */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

        /* ==================== Clickable Process Title ==================== */
        .process-event-title-text {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 6px;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .process-event-title-text:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .process-event-title-text:active {
            transform: scale(0.97);
        }

        /* ==================== Code Detail Modal ==================== */
        .code-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
        }

        .code-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .code-modal {
            background: var(--bg-white);
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 640px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: translateY(20px) scale(0.96);
            transition: transform 0.25s ease;
            overflow: hidden;
        }

        .code-modal-overlay.active .code-modal {
            transform: translateY(0) scale(1);
        }

        .code-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .code-modal-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }


        .code-modal-step-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 6px;
            background: var(--primary-light);
            color: var(--primary);
        }

        .code-modal-close {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .code-modal-close:hover {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .code-modal-close svg {
            width: 14px; height: 14px;
        }

        .code-modal-body {
            padding: 16px 20px 20px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .code-modal-block {
            font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            font-size: 13px;
            line-height: 1.8;
            color: var(--text-primary);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 18px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 60vh;
            overflow-y: auto;
        }

        .code-modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            gap: 8px;
        }

        .code-modal-btn {
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }

        .code-modal-btn-copy {
            background: var(--primary);
            color: white;
            border: none;
        }

        .code-modal-btn-copy:hover {
            background: var(--primary-hover);
        }

        .code-modal-btn-close {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .code-modal-btn-close:hover {
            background: var(--border-light);
            color: var(--text-primary);
        }

        .code-modal-btn svg {
            width: 14px; height: 14px;
        }

        /* ==================== Responsive ==================== */
        @media (max-width: 1024px) {
            .process-panel { width: 340px; }
        }

        @media (max-width: 768px) {
            .process-panel { display: none; }
            .chat-messages-inner { padding: 16px; }
            .input-area { padding: 12px 16px 16px; }
            .tips { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <div class="header-logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a5 5 0 0 1 5 5v3a5 5 0 0 1-10 0V7a5 5 0 0 1 5-5z"/>
                <path d="M8 14v1a4 4 0 0 0 8 0v-1"/>
                <line x1="12" y1="19" x2="12" y2="22"/>
                <line x1="8" y1="22" x2="16" y2="22"/>
            </svg>
        </div>
        <h1>AI 对话助手</h1>
    </div>
    <div class="header-actions">
        <button class="btn-clear" onclick="clearChat()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                <path d="M10 11v6"/><path d="M14 11v6"/>
                <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
            </svg>
            新对话
        </button>
    </div>
</div>

<div class="main-content">
    <!-- ===== 左侧: 对话面板 ===== -->
    <div class="chat-panel">
        <div class="chat-messages" id="chatMessages">
            <div class="chat-messages-inner" id="chatMessagesInner">
                <div class="welcome" id="welcome">
                    <div class="welcome-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                    </div>
                    <h2>你好，有什么可以帮你的？</h2>
                    <p>基于 Spring AI 构建的智能对话系统，支持工具调用与流式响应</p>
                    <div class="tips">
                        <span class="tip" onclick="useTip(this)">北京今天天气怎么样？</span>
                        <span class="tip" onclick="useTip(this)">介绍一下 Spring AI 框架</span>
                        <span class="tip" onclick="useTip(this)">用Java写一个快速排序</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 底部: 输入区域 ===== -->
        <div class="input-area">
            <div class="input-container">
                <textarea class="message-input"
                          id="messageInput"
                          placeholder="输入消息..."
                          rows="1"
                          onkeydown="handleKeyDown(event)"
                          oninput="autoResize(this)"
                          autocomplete="off"></textarea>
                <div class="input-actions">
                    <button class="btn-send" id="actionBtn" onclick="handleAction()" title="发送 (Enter)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-hint">Enter 发送 / Shift+Enter 换行</div>
        </div>
    </div>

    <!-- ===== 右侧: 处理流程面板 ===== -->
    <div class="process-panel">
        <div class="process-header">
            <h3>
                <span class="process-header-dot" id="statusDot"></span>
                处理流程
            </h3>
        </div>
        <div class="process-events" id="processEvents">
            <div class="process-empty" id="processEmpty">
                <div class="process-empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                    </svg>
                </div>
                发送消息后，这里将实时展示<br>
                AI 处理的每一个步骤<br><br>
                <span style="color: var(--text-tertiary);">模型初始化 → 提示词构建 → 工具调用 → 流式响应</span>
            </div>
        </div>
    </div>
</div>

<!-- ===== 代码详情弹框 ===== -->
<div class="code-modal-overlay" id="codeModalOverlay" onclick="closeCodeModal(event)">
    <div class="code-modal" onclick="event.stopPropagation()">
        <div class="code-modal-header">
            <div class="code-modal-header-left">
                <span id="codeModalTitle"></span>
                <span class="code-modal-step-badge" id="codeModalBadge"></span>
            </div>
            <button class="code-modal-close" onclick="closeCodeModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="code-modal-body">
            <div class="code-modal-block" id="codeModalBlock"></div>
        </div>
        <div class="code-modal-footer">
            <button class="code-modal-btn code-modal-btn-close" onclick="closeCodeModal()">关闭</button>
            <button class="code-modal-btn code-modal-btn-copy" onclick="copyCodeContent()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
                复制
            </button>
        </div>
    </div>
</div>

<script>
    // ==================== State ====================
    let eventSource = null;
    let currentAiTextEl = null;
    let currentAiText = '';
    let isStreaming = false;
    let streamingContentEl = null;
    let streamingText = '';
    let processEventDataList = [];

    // ==================== DOM Refs ====================
    const chatMessages = document.getElementById('chatMessages');
    const chatMessagesInner = document.getElementById('chatMessagesInner');
    const processEvents = document.getElementById('processEvents');
    const messageInput = document.getElementById('messageInput');
    const actionBtn = document.getElementById('actionBtn');
    const statusDot = document.getElementById('statusDot');

    // ==================== Auto-resize textarea ====================
    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 160) + 'px';
    }

    // ==================== Send Message ====================
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isStreaming) return;

        // Hide welcome
        const welcome = document.getElementById('welcome');
        if (welcome) welcome.style.display = 'none';

        // Add user message to chat panel
        addUserMessage(message);
        messageInput.value = '';
        messageInput.style.height = 'auto';

        // Clear process panel
        clearProcessPanel();

        // Start SSE streaming
        startStreaming(message);
    }

    // ==================== Chat Messages ====================
    function addUserMessage(text) {
        const div = document.createElement('div');
        div.className = 'message user';
        div.innerHTML = `
            <div class="message-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <div class="message-content">
                <div class="message-name">你</div>
                <div class="message-bubble">${escapeHtml(text)}</div>
            </div>
        `;
        chatMessagesInner.appendChild(div);
        scrollToBottom(chatMessages);
    }

    function addAiMessage() {
        const div = document.createElement('div');
        div.className = 'message ai';
        div.innerHTML = `
            <div class="message-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <div class="message-content">
                <div class="message-name">AI 助手</div>
                <div class="message-bubble">
                    <div class="ai-text"></div>
                    <div class="typing-indicator">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                </div>
            </div>
        `;
        chatMessagesInner.appendChild(div);
        currentAiTextEl = div.querySelector('.ai-text');
        currentAiText = '';
        scrollToBottom(chatMessages);
    }

    function appendAiText(token) {
        currentAiText += token;
        if (currentAiTextEl) {
            currentAiTextEl.innerHTML = renderMarkdown(currentAiText);
        }
        scrollToBottom(chatMessages);
    }

    function finishAiMessage() {
        // Remove typing indicators
        document.querySelectorAll('.typing-indicator').forEach(el => el.remove());
        // Final render
        if (currentAiTextEl && currentAiText) {
            currentAiTextEl.innerHTML = renderMarkdown(currentAiText);
        }
    }

    // ==================== SSE Streaming ====================
    function startStreaming(message) {
        isStreaming = true;
        streamingText = '';
        streamingContentEl = null;
        updateActionButton();
        statusDot.classList.add('active');

        addAiMessage();

        // Create EventSource for SSE
        const url = '/chat/stream?message=' + encodeURIComponent(message);
        eventSource = new EventSource(url);

        // AI text tokens → left panel
        eventSource.addEventListener('message', function(e) {
            appendAiText(e.data);
            updateStreamingText(e.data);
        });

        // Process events → right panel
        eventSource.addEventListener('process', function(e) {
            try {
                const event = JSON.parse(e.data);
                addProcessEvent(event);
            } catch (err) {
                console.error('Process event parse error:', err);
            }
        });

        // Close signal
        eventSource.addEventListener('close', function(e) {
            finishStreaming();
        });

        // Error handling (EventSource auto-reconnects, we prevent it)
        eventSource.onerror = function(e) {
            if (isStreaming) {
                finishStreaming();
            }
        };
    }

    function stopStreaming() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        finishStreaming();
    }

    function finishStreaming() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        isStreaming = false;
        finishAiMessage();
        updateActionButton();
        statusDot.classList.remove('active');
    }

    function updateActionButton() {
        if (isStreaming) {
            actionBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>`;
            actionBtn.className = 'btn-stop';
            actionBtn.title = '停止生成';
        } else {
            actionBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`;
            actionBtn.className = 'btn-send';
            actionBtn.title = '发送 (Enter)';
            messageInput.focus();
        }
    }

    function handleAction() {
        if (isStreaming) {
            stopStreaming();
        } else {
            sendMessage();
        }
    }

    // ==================== Process Events (Right Panel) ====================
    function clearProcessPanel() {
        processEvents.innerHTML = '';
        processEventDataList = [];
    }

    const STEP_ICONS = {
        model_init:    '',
        prompt_build:  '',
        tool_register: '',
        api_call:      '',
        streaming:     '',
        tool_call:     '',
        tool_result:   '',
        complete:      '',
        error:         ''
    };

    function addProcessEvent(event) {
        // Remove empty state
        const empty = document.getElementById('processEmpty');
        if (empty) empty.remove();

        const time = new Date(event.timestamp).toLocaleTimeString('zh-CN', {
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });

        const icon = STEP_ICONS[event.step] || '';

        const div = document.createElement('div');
        div.className = 'process-event ' + event.step;

        // For streaming step, we'll update its content with tokens
        const contentId = (event.step === 'streaming') ? 'id="streamingContent"' : '';

        // Store event data for modal use (detail 优先用于弹框展示)
        const eventIndex = processEventDataList.length;
        processEventDataList.push({
            title: event.title,
            step: event.step,
            icon: icon,
            content: event.content,
            detail: event.detail || null,
            time: time
        });

        div.innerHTML = `
            <div class="process-event-dot"></div>
            <div class="process-event-title">
                <span class="process-event-title-text" onclick="openCodeModal(${eventIndex})" title="点击查看详情">
                    ${escapeHtml(event.title)}
                </span>
                <span class="process-event-time">${time}</span>
            </div>
            <div class="process-event-content" ${contentId}>${escapeHtml(event.content)}</div>
        `;

        processEvents.appendChild(div);

        if (event.step === 'streaming') {
            streamingContentEl = div.querySelector('#streamingContent');
        }

        scrollToBottom(processEvents);
    }

    function updateStreamingText(token) {
        streamingText += token;
        if (streamingContentEl) {
            // Show latest portion if text is very long
            const display = streamingText.length > 600
                ? '...\n' + streamingText.slice(-600)
                : streamingText;
            streamingContentEl.textContent = display;
            scrollToBottom(processEvents);
        }
    }

    // ==================== Chat Actions ====================
    function clearChat() {
        // Stop any ongoing streaming
        if (isStreaming) stopStreaming();

        chatMessagesInner.innerHTML = `
            <div class="welcome" id="welcome">
                <div class="welcome-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                <h2>你好，有什么可以帮你的？</h2>
                <p>基于 Spring AI 构建的智能对话系统，支持工具调用与流式响应</p>
                <div class="tips">
                    <span class="tip" onclick="useTip(this)">现在几点了？</span>
                    <span class="tip" onclick="useTip(this)">北京今天天气怎么样？</span>
                    <span class="tip" onclick="useTip(this)">介绍一下 Spring AI 框架</span>
                    <span class="tip" onclick="useTip(this)">用Java写一个快速排序</span>
                </div>
            </div>
        `;

        processEvents.innerHTML = `
            <div class="process-empty" id="processEmpty">
                <div class="process-empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                    </svg>
                </div>
                发送消息后，这里将实时展示<br>
                AI 处理的每一个步骤<br><br>
                <span style="color: var(--text-tertiary);">模型初始化 → 提示词构建 → 工具调用 → 流式响应</span>
            </div>
        `;

        messageInput.focus();
    }

    function useTip(el) {
        // Extract text content without the icon
        const text = el.textContent.trim();
        messageInput.value = text;
        sendMessage();
    }

    function handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
            e.preventDefault();
            handleAction();
        }
    }

    // ==================== Utility ====================
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Simple markdown renderer
     * Supports: **bold**, *italic*, `code`, ```code blocks```, lists, line breaks
     */
    function renderMarkdown(text) {
        if (!text) return '';

        // Escape HTML first
        let html = escapeHtml(text);

        // Code blocks (```lang\n...\n```)
        html = html.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, lang, code) {
            return '<pre><code>' + code.trim() + '</code></pre>';
        });

        // Inline code
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

        // Bold
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // Italic
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

        // Unordered lists
        html = html.replace(/^[\s]*[-*]\s+(.+)$/gm, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

        // Ordered lists
        html = html.replace(/^[\s]*\d+\.\s+(.+)$/gm, '<li>$1</li>');

        // Paragraphs (double newline)
        html = html.replace(/\n\n/g, '</p><p>');

        // Single newlines → <br> (but not inside pre/code)
        html = html.replace(/(?<!<\/pre>|<\/code>)\n(?!<)/g, '<br>');

        // Wrap in paragraph
        if (html && !html.startsWith('<')) {
            html = '<p>' + html + '</p>';
        }

        return html;
    }

    // ==================== Code Detail Modal ====================
    const STEP_LABELS = {
        model_init:    '模型初始化',
        prompt_build:  '提示词构建',
        tool_register: '工具注册',
        api_call:      'API 调用',
        streaming:     '流式响应',
        tool_call:     '工具调用',
        tool_result:   '工具结果',
        complete:      '处理完成',
        error:         '错误'
    };

    function openCodeModal(eventIndex) {
        const data = processEventDataList[eventIndex];
        if (!data) return;

        // 优先使用 detail（后端指定的弹框内容），否则回退到 content
        let displayContent = data.detail || data.content;

        // streaming 步骤特殊处理：取最新的完整流文本
        if (data.step === 'streaming' && streamingText) {
            displayContent = data.detail || streamingText;
        }

        document.getElementById('codeModalTitle').textContent = data.title;
        document.getElementById('codeModalBadge').textContent = STEP_LABELS[data.step] || data.step;
        document.getElementById('codeModalBlock').textContent = displayContent;

        const overlay = document.getElementById('codeModalOverlay');
        overlay.classList.add('active');

        // Listen for Escape key
        document.addEventListener('keydown', handleModalEscape);
    }

    function closeCodeModal(event) {
        // If called from overlay click, only close if clicking the overlay itself
        if (event && event.target !== document.getElementById('codeModalOverlay')) return;

        const overlay = document.getElementById('codeModalOverlay');
        overlay.classList.remove('active');
        document.removeEventListener('keydown', handleModalEscape);
    }

    function handleModalEscape(e) {
        if (e.key === 'Escape') {
            closeCodeModal();
        }
    }

    function copyCodeContent() {
        const content = document.getElementById('codeModalBlock').textContent;
        navigator.clipboard.writeText(content).then(() => {
            const btn = document.querySelector('.code-modal-btn-copy');
            const original = btn.innerHTML;
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> 已复制`;
            btn.style.background = '#10B981';
            setTimeout(() => {
                btn.innerHTML = original;
                btn.style.background = '';
            }, 1500);
        });
    }

    function scrollToBottom(el) {
        requestAnimationFrame(() => {
            el.scrollTop = el.scrollHeight;
        });
    }

    // Focus input on page load
    messageInput.focus();
</script>

</body>
</html>
